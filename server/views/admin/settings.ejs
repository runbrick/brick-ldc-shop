<%- include('partials/header', { title: '设置', user }) %>
<h1 class="text-xl font-bold text-platform-primary mb-8">设置</h1>
<% if (typeof query !== 'undefined' && query.ok === '1') { %>
<div class="platform-card p-4 mb-8 border border-emerald-200 bg-emerald-50/80 text-green-800 text-sm">已保存</div>
<% } %>

<div class="flex flex-col md:flex-row gap-8">
  <!-- Tabs -->
  <div class="w-full md:w-48 flex-shrink-0">
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden sticky top-24">
      <a href="#basic" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent hover:border-emerald-500 transition-colors" onclick="switchTab('basic', this)">基本设置</a>
      <a href="#points" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent hover:border-emerald-500 transition-colors" onclick="switchTab('points', this)">积分设置</a>
      <a href="#payment" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent hover:border-emerald-500 transition-colors" onclick="switchTab('payment', this)">支付设置</a>
      <a href="#footer" class="block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent hover:border-emerald-500 transition-colors" onclick="switchTab('footer', this)">页脚配置</a>
    </div>
  </div>

  <!-- Content -->
  <form method="post" action="/admin/settings" enctype="multipart/form-data" class="flex-1 space-y-8">
    
    <!-- Basic Settings Section -->
    <div id="section-basic" class="settings-section">
      <div class="platform-card p-6">
        <h2 class="text-lg font-bold text-platform-primary mb-6 pb-2 border-b border-gray-100">基本设置</h2>
        <div class="space-y-6">
          <div>
            <label class="block text-platform-muted font-medium mb-2">商城名称</label>
            <input type="text" name="site_name" value="<%= typeof siteName !== 'undefined' ? siteName : '' %>" placeholder="发卡平台" maxlength="64" class="platform-input px-3 py-2 w-full" />
            <p class="text-platform-soft text-sm mt-2">用于前台导航栏、页面标题等展示</p>
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页副标题</label>
            <input type="text" name="home_subtitle" value="<%= typeof homeSubtitle !== 'undefined' ? homeSubtitle : '' %>" placeholder="选择商品，使用 Linux.do 积分支付" maxlength="128" class="platform-input px-3 py-2 w-full" />
            <p class="text-platform-soft text-sm mt-2">显示在首页标题下方的提示语</p>
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页横幅小标题</label>
            <input type="text" name="home_hero_kicker" value="<%= typeof homeHeroKicker !== 'undefined' ? homeHeroKicker : '' %>" placeholder="欢迎来到" maxlength="32" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页横幅主标题</label>
            <input type="text" name="home_hero_title" value="<%= typeof homeHeroTitle !== 'undefined' ? homeHeroTitle : '' %>" placeholder="精选卡密专区" maxlength="64" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页横幅描述</label>
            <input type="text" name="home_hero_desc" value="<%= typeof homeHeroDesc !== 'undefined' ? homeHeroDesc : '' %>" placeholder="添加一句简短说明" maxlength="128" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">右侧卡片小标题</label>
            <input type="text" name="home_card_kicker" value="<%= typeof homeCardKicker !== 'undefined' ? homeCardKicker : '' %>" placeholder="欢迎访问" maxlength="32" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">右侧卡片主标题</label>
            <input type="text" name="home_card_title" value="<%= typeof homeCardTitle !== 'undefined' ? homeCardTitle : '' %>" placeholder="个人小店" maxlength="64" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">右侧卡片描述</label>
            <input type="text" name="home_card_desc" value="<%= typeof homeCardDesc !== 'undefined' ? homeCardDesc : '' %>" placeholder="打开秘境之门，让梦想在星光中绽放。" maxlength="128" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页卖点一</label>
            <input type="text" name="home_feature_1" value="<%= typeof homeFeature1 !== 'undefined' ? homeFeature1 : '' %>" placeholder="自动发货" maxlength="32" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页卖点二</label>
            <input type="text" name="home_feature_2" value="<%= typeof homeFeature2 !== 'undefined' ? homeFeature2 : '' %>" placeholder="保障安全" maxlength="32" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">首页卖点三</label>
            <input type="text" name="home_feature_3" value="<%= typeof homeFeature3 !== 'undefined' ? homeFeature3 : '' %>" placeholder="实时查询" maxlength="32" class="platform-input px-3 py-2 w-full" />
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">网站背景图</label>
            <% if (typeof siteBackground !== 'undefined' && siteBackground) { %>
            <div class="mb-2"><img src="<%= siteBackground %>" alt="背景" class="max-h-24 rounded-lg border border-slate-200" /></div>
            <% } %>
            <input type="file" name="site_background_image" accept="image/*" class="platform-input px-3 py-2 w-full text-sm" />
            <p class="text-platform-soft text-sm mt-2">上传图片作为整站背景，留空则保持当前背景</p>
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">库存预警阈值</label>
            <input type="number" name="inventory_warning" value="<%= typeof inventoryWarning !== 'undefined' ? inventoryWarning : '5' %>" min="0" class="platform-input px-3 py-2 w-full" />
            <p class="text-platform-soft text-sm mt-2">当商品库存低于此数值时，管理后台将显示预警</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Points Settings Section -->
    <div id="section-points" class="settings-section hidden">
      <div class="platform-card p-6">
        <h2 class="text-lg font-bold text-platform-primary mb-6 pb-2 border-b border-gray-100">积分设置</h2>
        <div class="space-y-6">
          <div>
            <label class="block text-platform-muted font-medium mb-2">每日签到积分</label>
            <input type="number" name="checkin_points" value="<%= typeof checkinPoints !== 'undefined' ? checkinPoints : '10' %>" min="0" class="platform-input px-3 py-2 w-full" />
            <p class="text-platform-soft text-sm mt-2">用户每日点击签到可获得的积分数量</p>
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">积分抵扣比例 (1 LDC = X 平台积分)</label>
            <input type="number" name="points_ratio" value="<%= typeof pointsRatio !== 'undefined' ? pointsRatio : '100' %>" min="1" class="platform-input px-3 py-2 w-full" />
            <p class="text-platform-soft text-sm mt-2">设置多少积分可以抵扣 1 LDC（或 1 个货币单位）</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Settings Section -->
    <div id="section-payment" class="settings-section hidden">
      <div class="platform-card p-6">
        <h2 class="text-lg font-bold text-platform-primary mb-6 pb-2 border-b border-gray-100">支付设置</h2>
        <div class="space-y-6">
          <div>
            <label class="block text-platform-muted font-medium mb-2">收款二维码</label>
            <% if (typeof paymentQR !== 'undefined' && paymentQR) { %>
            <div class="mb-2"><img src="<%= paymentQR %>" alt="收款码" class="max-h-48 rounded-lg border border-slate-200" /></div>
            <% } %>
            <input type="file" name="payment_qr_image" accept="image/*" class="platform-input px-3 py-2 w-full text-sm" />
            <p class="text-platform-soft text-sm mt-2">上传收款二维码，将在待支付订单页面展示，供用户扫码支付。留空则不展示。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Settings Section -->
    <div id="section-footer" class="settings-section hidden">
      <div class="platform-card p-6">
        <h2 class="text-lg font-bold text-platform-primary mb-6 pb-2 border-b border-gray-100">页脚配置</h2>
        
        <div class="mb-6">
          <label class="block text-platform-muted font-medium mb-2">简单页脚文案（仅当未配置多栏页脚时显示）</label>
          <textarea name="site_footer_text" id="site_footer_text" rows="2" class="platform-input px-3 py-2 w-full"><%= typeof siteFooterText !== 'undefined' ? siteFooterText : '' %></textarea>
          <p class="text-platform-soft text-sm mt-2">显示在前台页面底部，可填写 HTML</p>
        </div>

        <div class="grid grid-cols-1 gap-6">
          <div>
            <label class="block text-platform-muted font-medium mb-2">第一栏（Logo/简介）</label>
            <textarea name="footer_col1" rows="6" class="platform-input px-3 py-2 w-full font-mono text-sm" placeholder="<img src='...' class='h-12 mb-4'>&#10;<p>这里是简介...</p>"><%= typeof footerCol1 !== 'undefined' ? footerCol1 : '' %></textarea>
          </div>
          <!-- 第二栏（快捷导航）已移除 -->
          <div>
            <label class="block text-platform-muted font-medium mb-2">第三栏（免责声明）</label>
            <textarea name="footer_col3" rows="6" class="platform-input px-3 py-2 w-full font-mono text-sm" placeholder="<h4 class='font-bold mb-4'>免责声明</h4>&#10;<p>本站资源...</p>"><%= typeof footerCol3 !== 'undefined' ? footerCol3 : '' %></textarea>
          </div>
          <div>
            <label class="block text-platform-muted font-medium mb-2">第四栏（联系方式）</label>
            <textarea name="footer_col4" rows="6" class="platform-input px-3 py-2 w-full font-mono text-sm" placeholder="<h4 class='font-bold mb-4'>联系方式</h4>&#10;<p>QQ: ...</p>"><%= typeof footerCol4 !== 'undefined' ? footerCol4 : '' %></textarea>
          </div>
        </div>
        <div class="mt-6 text-sm text-platform-soft">
          提示：友情链接请在左侧菜单“友情链接”中独立管理。
        </div>
      </div>
    </div>

    <div class="sticky bottom-6 z-40">
      <div class="platform-card p-4 flex justify-end bg-white/90 backdrop-blur shadow-lg border border-emerald-100">
        <button type="submit" class="btn-primary cursor-pointer px-8">保存设置</button>
      </div>
    </div>
  </form>
</div>

<script>
function switchTab(id, el) {
  // Update tabs
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
    a.classList.add('border-transparent');
  });
  el.classList.remove('border-transparent');
  el.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');

  // Update content
  document.querySelectorAll('.settings-section').forEach(s => s.classList.add('hidden'));
  document.getElementById('section-' + id).classList.remove('hidden');
  
  // Prevent jump
  event.preventDefault();
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  const hash = location.hash.replace('#', '') || 'basic';
  const tab = document.querySelector(`a[href="#${hash}"]`);
  if (tab) switchTab(hash, tab);
  else switchTab('basic', document.querySelector(`a[href="#basic"]`));
});
</script>
<%- include('partials/footer') %>
