<%- include('partials/header') %>

<main class="flex-1 p-6">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div>
      <h1 class="text-2xl font-bold text-platform-primary">顾客管理</h1>
      <p class="text-platform-soft text-sm mt-1">查看和管理商城的所有注册用户</p>
    </div>
    
    <div class="flex items-center gap-2">
      <form action="/admin/users" method="GET" class="flex gap-2">
        <input 
          type="text" 
          name="keyword" 
          value="<%= query.keyword || '' %>" 
          placeholder="搜索 ID / 用户名 / 邮箱" 
          class="platform-input py-2 px-4 w-64"
        >
        <button type="submit" class="platform-button-primary py-2 px-6">搜索</button>
      </form>
    </div>
  </div>

  <% if (query.error === 'self') { %>
    <div class="bg-red-50 text-red-600 p-4 rounded-xl mb-6 text-sm flex items-center gap-2">
      <span class="text-lg">⚠️</span> 不能对自己进行管理员权限操作
    </div>
  <% } %>

  <div class="platform-card overflow-hidden border border-slate-200">
    <div class="overflow-x-auto">
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="border-b border-slate-100 text-platform-soft">
            <th class="py-3 px-4 font-medium">用户信息</th>
            <th class="py-3 px-4 font-medium">积分</th>
            <th class="py-3 px-4 font-medium">订单统计</th>
            <th class="py-3 px-4 font-medium">注册时间</th>
            <th class="py-3 px-4 font-medium">状态</th>
            <th class="py-3 px-4 font-medium text-right">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-50">
          <% users.forEach(u => { %>
            <tr class="hover:bg-slate-50 transition-colors <%= u.is_banned ? 'bg-red-50/30' : '' %>">
              <td class="py-4 px-4">
                <div class="flex items-center gap-3">
                  <img src="<%= u.avatar_url || '/default-avatar.png' %>" class="w-10 h-10 rounded-full border border-slate-100 object-cover" alt="">
                  <div>
                    <div class="font-medium text-platform-primary flex items-center gap-1">
                      <%= u.username %>
                      <% if (u.is_admin) { %>
                        <span class="px-1.5 py-0.5 bg-amber-50 text-amber-600 text-[10px] rounded border border-amber-100 font-bold uppercase">Admin</span>
                      <% } %>
                    </div>
                    <div class="text-platform-soft text-xs break-all max-w-[16rem]"><%= u.email || '无邮箱' %> (ID: <%= u.id %>)</div>
                  </div>
                </div>
              </td>
              <td class="py-4 px-4 whitespace-nowrap">
                <form action="/admin/users/<%= u.id %>/update-points" method="POST" class="flex items-center gap-2">
                  <input type="number" name="points" value="<%= u.points %>" class="w-20 platform-input py-1 px-2 text-center text-xs" min="0">
                  <button type="submit" class="text-platform-primary hover:text-platform-primary/80 text-xs">修改</button>
                </form>
              </td>
              <td class="py-4 px-4 whitespace-nowrap">
                <div class="text-platform-primary font-medium"><%= u.order_count %> 笔订单</div>
                <div class="text-platform-soft text-xs">消费 <%= Number(u.total_spent || 0).toFixed(2) %> 积分</div>
              </td>
              <td class="py-4 px-4 text-platform-soft text-xs whitespace-nowrap">
                <%= u.created_at %>
              </td>
              <td class="py-4 px-4 whitespace-nowrap">
                <% if (u.is_banned) { %>
                  <span class="px-2 py-0.5 bg-red-100 text-red-600 text-[10px] rounded-full font-medium">已拉黑</span>
                <% } else { %>
                  <span class="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-[10px] rounded-full font-medium">正常</span>
                <% } %>
              </td>
              <td class="py-4 px-4 text-right whitespace-nowrap">
                <div class="flex items-center justify-end gap-3">
                  <form action="/admin/users/<%= u.id %>/toggle-ban" method="POST" class="inline">
                    <button type="submit" class="<%= u.is_banned ? 'text-emerald-600' : 'text-red-500' %> hover:opacity-80 transition-opacity text-xs font-medium">
                      <%= u.is_banned ? '解封' : '拉黑' %>
                    </button>
                  </form>
                  <form action="/admin/users/<%= u.id %>/toggle-admin" method="POST" class="inline">
                    <button type="submit" class="text-slate-500 hover:text-platform-primary transition-colors text-xs font-medium">
                      <%= u.is_admin ? '撤销管理' : '设为管理' %>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (pagination.totalPages > 1) { %>
    <div class="mt-8 flex justify-center items-center gap-2">
      <% if (pagination.page > 1) { %>
        <a href="?page=<%= pagination.page - 1 %><%= query.keyword ? '&keyword=' + query.keyword : '' %>" class="w-10 h-10 flex items-center justify-center rounded-xl border border-slate-200 text-platform-soft hover:bg-slate-50 transition-colors">&laquo;</a>
      <% } %>
      
      <span class="text-sm text-platform-soft px-4">第 <%= pagination.page %> / <%= pagination.totalPages %> 页</span>

      <% if (pagination.page < pagination.totalPages) { %>
        <a href="?page=<%= pagination.page + 1 %><%= query.keyword ? '&keyword=' + query.keyword : '' %>" class="w-10 h-10 flex items-center justify-center rounded-xl border border-slate-200 text-platform-soft hover:bg-slate-50 transition-colors">&raquo;</a>
      <% } %>
    </div>
  <% } %>
</main>

<%- include('partials/footer') %>
