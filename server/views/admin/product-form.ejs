<%- include('partials/header', { title: product ? '编辑商品' : '新建商品', user }) %>
<h1 class="text-xl font-bold text-platform-primary mb-8"><%= product ? '编辑商品' : '新建商品' %></h1>
<form method="post" action="<%= product ? '/admin/products/' + product.id : '/admin/products' %>" enctype="multipart/form-data" class="max-w-xl space-y-6">
  <div>
    <label class="block text-platform-muted font-medium mb-2">名称</label>
    <input type="text" name="name" value="<%= product ? product.name : '' %>" required class="platform-input px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-2">自定义路由 (Slug)</label>
    <input type="text" name="slug" value="<%= product && product.slug ? product.slug : '' %>" placeholder="留空则根据名称自动生成拼音，如：my-product" class="platform-input px-3 py-2 w-full" pattern="[a-zA-Z0-9-_]+" />
    <p class="text-platform-soft text-sm mt-1">仅允许字母、数字、横杠和下划线。生成后访问地址为 /shop/product/custom-slug</p>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">首图</label>
    <% if (product && product.cover_image) { %>
    <div class="mb-2"><img src="<%= product.cover_image %>" alt="首图" class="h-24 object-cover rounded-lg border border-slate-200" /></div>
    <% } %>
    <input type="file" name="cover_image" accept="image/*" class="platform-input px-3 py-2 w-full text-sm" />
    <p class="text-platform-soft text-sm mt-1">商品列表与详情页展示，留空则保持当前图</p>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">说明（支持 Markdown，可上传图片）</label>
    <textarea name="description" id="description" rows="8" class="platform-input px-3 py-2 w-full font-mono text-sm"><%= product ? (product.description || '') : '' %></textarea>
    <p class="text-platform-soft text-sm mt-1">支持 **粗体**、[链接](url)、![图片](url)。点击工具栏图片按钮可上传并插入图片。</p>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-2">分类</label>
    <select name="category_id" class="platform-input px-3 py-2 max-w-xs">
      <option value="">未分类</option>
      <% (categoryTree || []).forEach(function(p) { %>
      <option value="<%= p.id %>" <%= product && product.category_id == p.id ? 'selected' : '' %>><%= p.name %>（一级）</option>
      <% (p.children || []).forEach(function(c) { %>
      <option value="<%= c.id %>" <%= product && product.category_id == c.id ? 'selected' : '' %>><%= p.name %> → <%= c.name %></option>
      <% }); %>
      <% }); %>
    </select>
    <p class="text-platform-soft text-sm mt-1">在 <a href="/admin/categories" class="text-primary hover:underline cursor-pointer">分类管理</a> 中维护一级/二级分类</p>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">价格（积分）</label>
    <div class="flex items-center gap-4">
      <div>
        <span class="text-xs text-platform-soft block mb-1">现价</span>
        <input type="number" name="price" step="0.01" min="0" value="<%= product ? product.price : '' %>" required class="platform-input px-3 py-2 w-32" />
      </div>
      <div>
        <span class="text-xs text-platform-soft block mb-1">原价（可选，展示划线价）</span>
        <input type="number" name="original_price" step="0.01" min="0" value="<%= product ? product.original_price : '' %>" class="platform-input px-3 py-2 w-32" />
      </div>
    </div>
  </div>
  <div class="flex gap-8">
    <div>
      <label class="block text-platform-muted font-medium mb-1">库存</label>
      <input type="number" name="stock" min="-1" value="<%= product ? product.stock : '0' %>" class="platform-input px-3 py-2 w-32" />
      <p class="text-platform-soft text-sm mt-1">填 -1 表示无限库存</p>
    </div>
    <div>
      <label class="block text-platform-muted font-medium mb-1">限购数量</label>
      <input type="number" name="purchase_limit" min="0" value="<%= product ? product.purchase_limit : '0' %>" class="platform-input px-3 py-2 w-32" />
      <p class="text-platform-soft text-sm mt-1">每个用户限购总量，0 为不限</p>
    </div>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">热门推荐</label>
    <label class="inline-flex items-center cursor-pointer text-platform-muted">
      <input type="checkbox" name="is_hot" value="1" <%= product && product.is_hot === 1 ? 'checked' : '' %> class="mr-2" /> 设为热门商品（首页展示热门标记）
    </label>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">卡密类型</label>
    <div class="flex gap-4">
      <label class="inline-flex items-center cursor-pointer text-platform-muted">
        <input type="radio" name="card_mode" value="0" <%= !product || product.card_mode !== 1 ? 'checked' : '' %> class="mr-2" /> 一次性卡密（每张卡仅可使用一次）
      </label>
      <label class="inline-flex items-center cursor-pointer text-platform-muted">
        <input type="radio" name="card_mode" value="1" <%= product && product.card_mode === 1 ? 'checked' : '' %> class="mr-2" /> 循环卡密（卡密池循环使用）
      </label>
    </div>
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">排序（大靠前）</label>
    <input type="number" name="sort" value="<%= product ? product.sort : '0' %>" class="platform-input px-3 py-2 w-32" />
  </div>
  <div>
    <label class="block text-platform-muted font-medium mb-1">状态</label>
    <select name="status" class="platform-input px-3 py-2">
      <option value="1" <%= product && product.status === 1 ? 'selected' : '' %>>上架</option>
      <option value="0" <%= product && product.status === 0 ? 'selected' : '' %>>下架</option>
    </select>
  </div>
  <button type="submit" class="btn-primary cursor-pointer">保存</button>
  <a href="/admin/products" class="text-platform-muted hover:underline ml-4 cursor-pointer">取消</a>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css" />
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
(function() {
  var el = document.getElementById('description');
  if (!el) return;
  var easyMDE = new EasyMDE({
    element: el,
    spellChecker: false,
    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side'],
    status: ['lines', 'words'],
    insertTexts: { image: ['![', '](图片地址)'] }
  });
  var origToolbar = easyMDE.toolbar;
  var imgBtn = document.createElement('button');
  imgBtn.type = 'button';
  imgBtn.className = 'editor-toolbar-button';
  imgBtn.title = '上传图片';
  imgBtn.setAttribute('aria-label', '上传图片');
  imgBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
  imgBtn.onclick = function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function() {
      if (!input.files || !input.files[0]) return;
      var fd = new FormData();
      fd.append('file', input.files[0]);
      fetch('/admin/upload/image', { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.ok && d.url) easyMDE.codemirror.replaceSelection('![](' + d.url + ')');
        });
    };
    input.click();
  };
  var tb = document.querySelector('.EasyMDEContainer .editor-toolbar');
  if (tb) tb.appendChild(imgBtn);
})();
</script>
<%- include('partials/footer') %>
