<%- include('partials/header', { title: product ? 'ç¼–è¾‘å•†å“' : 'æ–°å»ºå•†å“', user }) %>
<h1 class="text-xl font-bold text-warm-900 mb-8"><%= product ? 'ç¼–è¾‘å•†å“' : 'æ–°å»ºå•†å“' %></h1>
<form method="post" action="<%= product ? '/admin/products/' + product.id : '/admin/products' %>" enctype="multipart/form-data" class="max-w-xl space-y-6">
  <div>
    <label class="block text-snug-700 font-medium mb-2">åç§°</label>
    <input type="text" name="name" value="<%= product ? product.name : '' %>" required class="skeuo-input px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">é¦–å›¾</label>
    <% if (product && product.cover_image) { %>
    <div class="mb-2"><img src="<%= product.cover_image %>" alt="é¦–å›¾" class="h-24 object-cover rounded border" style="border-color: rgba(180,160,130,0.5);" /></div>
    <% } %>
    <input type="file" name="cover_image" accept="image/*" class="skeuo-input px-3 py-2 w-full text-sm" />
    <p class="text-snug-500 text-sm mt-1">å•†å“åˆ—è¡¨ä¸è¯¦æƒ…é¡µå±•ç¤ºï¼Œç•™ç©ºåˆ™ä¿æŒå½“å‰å›¾</p>
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">è¯´æ˜ï¼ˆæ”¯æŒ Markdownï¼Œå¯ä¸Šä¼ å›¾ç‰‡ï¼‰</label>
    <textarea name="description" id="description" rows="8" class="skeuo-input px-3 py-2 w-full font-mono text-sm"><%= product ? (product.description || '') : '' %></textarea>
    <p class="text-snug-500 text-sm mt-1">æ”¯æŒ **ç²—ä½“**ã€[é“¾æ¥](url)ã€![å›¾ç‰‡](url)ã€‚ç‚¹å‡»å·¥å…·æ å›¾ç‰‡æŒ‰é’®å¯ä¸Šä¼ å¹¶æ’å…¥å›¾ç‰‡ã€‚</p>
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-2">åˆ†ç±»</label>
    <select name="category_id" class="skeuo-input px-3 py-2 max-w-xs">
      <option value="">æœªåˆ†ç±»</option>
      <% (categoryTree || []).forEach(function(p) { %>
      <option value="<%= p.id %>" <%= product && product.category_id == p.id ? 'selected' : '' %>><%= p.name %>ï¼ˆä¸€çº§ï¼‰</option>
      <% (p.children || []).forEach(function(c) { %>
      <option value="<%= c.id %>" <%= product && product.category_id == c.id ? 'selected' : '' %>><%= p.name %> â†’ <%= c.name %></option>
      <% }); %>
      <% }); %>
    </select>
    <p class="text-snug-500 text-sm mt-1">åœ¨ <a href="/admin/categories" class="text-primary hover:underline">åˆ†ç±»ç®¡ç†</a> ä¸­ç»´æŠ¤ä¸€çº§/äºŒçº§åˆ†ç±»</p>
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">ä»·æ ¼ï¼ˆç§¯åˆ†ï¼‰</label>
    <input type="number" name="price" step="0.01" min="0" value="<%= product ? product.price : '' %>" required class="skeuo-input px-3 py-2 w-32" />
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">åº“å­˜</label>
    <input type="number" name="stock" min="-1" value="<%= product ? product.stock : '0' %>" class="skeuo-input px-3 py-2 w-32" />
    <p class="text-snug-500 text-sm mt-1">å¡« -1 è¡¨ç¤ºæ— é™åº“å­˜</p>
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">å¡å¯†ç±»å‹</label>
    <div class="flex gap-4">
      <label class="inline-flex items-center cursor-pointer text-snug-700">
        <input type="radio" name="card_mode" value="0" <%= !product || product.card_mode !== 1 ? 'checked' : '' %> class="mr-2" /> ä¸€æ¬¡æ€§å¡å¯†ï¼ˆæ¯å¼ å¡ä»…å¯ä½¿ç”¨ä¸€æ¬¡ï¼‰
      </label>
      <label class="inline-flex items-center cursor-pointer text-snug-700">
        <input type="radio" name="card_mode" value="1" <%= product && product.card_mode === 1 ? 'checked' : '' %> class="mr-2" /> å¾ªç¯å¡å¯†ï¼ˆå¡å¯†æ± å¾ªç¯ä½¿ç”¨ï¼‰
      </label>
    </div>
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">æ’åºï¼ˆå¤§é å‰ï¼‰</label>
    <input type="number" name="sort" value="<%= product ? product.sort : '0' %>" class="skeuo-input px-3 py-2 w-32" />
  </div>
  <div>
    <label class="block text-snug-700 font-medium mb-1">çŠ¶æ€</label>
    <select name="status" class="skeuo-input px-3 py-2">
      <option value="1" <%= product && product.status === 1 ? 'selected' : '' %>>ä¸Šæ¶</option>
      <option value="0" <%= product && product.status === 0 ? 'selected' : '' %>>ä¸‹æ¶</option>
    </select>
  </div>
  <button type="submit" class="btn-primary">ä¿å­˜</button>
  <a href="/admin/products" class="text-snug-700 hover:underline ml-4 cursor-pointer">å–æ¶ˆ</a>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css" />
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
(function() {
  var el = document.getElementById('description');
  if (!el) return;
  var easyMDE = new EasyMDE({
    element: el,
    spellChecker: false,
    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side'],
    status: ['lines', 'words'],
    insertTexts: { image: ['![', '](å›¾ç‰‡åœ°å€)'] }
  });
  var origToolbar = easyMDE.toolbar;
  var imgBtn = document.createElement('button');
  imgBtn.type = 'button';
  imgBtn.className = 'editor-toolbar-button';
  imgBtn.title = 'ä¸Šä¼ å›¾ç‰‡';
  imgBtn.setAttribute('aria-label', 'ä¸Šä¼ å›¾ç‰‡');
  imgBtn.textContent = 'ğŸ–¼';
  imgBtn.onclick = function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function() {
      if (!input.files || !input.files[0]) return;
      var fd = new FormData();
      fd.append('file', input.files[0]);
      fetch('/admin/upload/image', { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.ok && d.url) easyMDE.codemirror.replaceSelection('![](' + d.url + ')');
        });
    };
    input.click();
  };
  var tb = document.querySelector('.EasyMDEContainer .editor-toolbar');
  if (tb) tb.appendChild(imgBtn);
})();
</script>
<%- include('partials/footer') %>
