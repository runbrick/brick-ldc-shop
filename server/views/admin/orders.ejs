<%- include('partials/header', { title: '订单管理', user }) %>
<h1 class="text-xl font-bold text-platform-primary mb-8">订单列表</h1>
<% if (typeof query !== 'undefined' && query.refund === 'ok') { %>
<div class="platform-card p-4 mb-6 border border-emerald-200 bg-emerald-50/80 text-green-800 text-sm"><%= typeof query !== 'undefined' && query.synced === '1' ? '该订单已在支付渠道完成退款，已同步状态。' : '退款成功' %></div>
<% } %>
<% if (typeof query !== 'undefined' && query.refund_reject === 'ok') { %>
<div class="platform-card p-4 mb-6 border border-slate-200 text-platform-muted text-sm">已拒绝该退款申请</div>
<% } %>
<% if (typeof query !== 'undefined' && query.error === 'refund') { %>
<div class="platform-card p-4 mb-6 border border-amber-200 bg-amber-50/80 text-amber-900 text-sm">退款失败：<%= typeof query !== 'undefined' && query.msg ? decodeURIComponent(query.msg) : '订单状态不允许或接口异常' %></div>
<% } %>
<div class="platform-card overflow-hidden border border-slate-200">
  <table class="w-full text-left">
    <thead class="border-b border-slate-200 bg-slate-50">
      <tr>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">订单号</th>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">商品</th>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">金额</th>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">状态</th>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">时间</th>
        <th class="px-4 py-3 text-platform-muted font-medium text-sm">操作</th>
      </tr>
    </thead>
    <tbody>
      <% (orders || []).forEach(function(o) { %>
      <tr class="border-b border-slate-200 hover:bg-slate-50 transition-colors duration-200">
        <td class="px-4 py-3 font-mono text-sm text-platform-primary"><%= o.order_no %></td>
        <td class="px-4 py-3 text-platform-primary"><%= o.product_name %> x<%= o.quantity %></td>
        <td class="px-4 py-3 text-platform-primary"><%= Number(o.amount).toFixed(2) %> 积分</td>
        <td class="px-4 py-3 text-platform-primary"><% if (o.status === 'paid') { %>已支付<% } else if (o.status === 'pending') { %>待支付<% } else if (o.status === 'refunded') { %>已退款<% } else { %><%= o.status %><% } %></td>
        <td class="px-4 py-3 text-platform-soft text-sm"><%= o.created_at %></td>
        <td class="px-4 py-3">
          <% if (o.refund_request) { %>
          <span class="text-amber-600 mr-2 text-sm">申请退款中</span>
          <form action="/admin/orders/<%= o.id %>/refund-approve" method="post" class="inline" onsubmit="return confirm('确定同意该退款申请？');">
            <button type="submit" class="text-green-600 hover:underline cursor-pointer">同意退款</button>
          </form>
          <span class="text-slate-300 mx-1">|</span>
          <form action="/admin/orders/<%= o.id %>/refund-reject" method="post" class="inline" onsubmit="return confirm('确定拒绝该退款申请？');">
            <button type="submit" class="text-platform-muted hover:underline cursor-pointer">拒绝</button>
          </form>
          <% } else if (o.status === 'paid' && o.epay_trade_no) { %>
          <form action="/admin/orders/<%= o.id %>/refund" method="post" class="inline" onsubmit="return confirm('确定退款？');">
            <button type="submit" class="text-amber-600 hover:underline cursor-pointer">退款</button>
          </form>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  <% if (!orders || orders.length === 0) { %>
  <div class="p-16 text-center text-platform-soft">暂无订单</div>
  <% } %>
</div>
<%- include('partials/pagination', { basePath: '/admin/orders', pagination: typeof pagination !== 'undefined' ? pagination : null, query: typeof query !== 'undefined' ? query : {} }) %>
<%- include('partials/footer') %>
