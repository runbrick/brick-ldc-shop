<%- include('../partials/header', { title: '订单结果', user }) %>
<div class="max-w-xl mx-auto text-center py-8">
  <% if (order && order.status === 'paid') { %>
  <div class="snug-card p-8 mb-8 bg-emerald-50/80 border-emerald-200/60 text-green-800">
    <h1 class="text-xl font-bold text-green-800 mb-2">支付成功</h1>
    <p class="text-green-700">订单号：<%= order.order_no %></p>
  </div>
  <div class="snug-card p-8 text-left">
    <h2 class="font-semibold text-warm-900 mb-4">卡密信息</h2>
    <div id="cardsList" class="space-y-2 font-mono text-sm bg-cloud-50 border border-cloud-300 p-5 rounded-xl">
      <span class="text-snug-500">加载中…</span>
    </div>
    <p class="text-snug-500 text-sm mt-4">请妥善保存，勿泄露他人。</p>
  </div>
  <script>
    (function() {
      var orderNo = '<%= order.order_no %>';
      var list = document.getElementById('cardsList');
      function poll() {
        fetch('/shop/order/' + orderNo + '/cards', { credentials: 'same-origin' })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            if (d.status === 'paid' && d.cards && d.cards.length) {
              list.innerHTML = d.cards.map(function(c) { return '<div class="break-all">' + c + '</div>'; }).join('');
              return;
            }
            setTimeout(poll, 1500);
          });
      }
      poll();
    })();
  </script>
  <% } else if (order) { %>
  <div class="snug-card p-8 text-amber-900 bg-amber-50/80 border-amber-200/60" id="pendingBlock">
    <h1 class="text-xl font-bold text-amber-800 mb-2">正在确认支付结果…</h1>
    <p class="text-amber-700">订单号：<%= order.order_no %></p>
    <p class="text-snug-500 text-sm mt-2" id="pendingHint">请稍候，正在向支付网关查询。</p>
  </div>
  <script>
    (function() {
      var orderNo = '<%= order.order_no %>';
      var block = document.getElementById('pendingBlock');
      var hint = document.getElementById('pendingHint');
      var attempts = 0;
      var maxAttempts = 10;
      function poll() {
        attempts++;
        fetch('/api/pay/order-status/' + orderNo, { credentials: 'same-origin' })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            if (d.status === 'paid') {
              location.reload();
              return;
            }
            if (attempts < maxAttempts) {
              hint.textContent = '正在查询…（' + attempts + '/' + maxAttempts + '）';
              setTimeout(poll, 1500);
            } else {
              block.classList.remove('bg-amber-50/80', 'border-amber-200/60');
              block.classList.add('bg-cloud-50', 'border-cloud-300');
              block.querySelector('h1').textContent = '等待支付';
              block.querySelector('h1').classList.remove('text-amber-800');
              block.querySelector('h1').classList.add('text-warm-900');
              hint.textContent = '若已完成支付，请刷新本页或到「我的订单」查看。';
            }
          })
          .catch(function() {
            if (attempts < maxAttempts) setTimeout(poll, 1500);
          });
      }
      poll();
    })();
  </script>
  <% } else { %>
  <div class="snug-card p-8">
    <p class="text-snug-700">未找到订单 <%= typeof orderNo !== 'undefined' ? orderNo : '' %>。</p>
  </div>
  <% } %>
  <a href="/shop" class="btn-primary mt-8 inline-block">返回商城</a>
</div>
<%- include('../partials/footer') %>
