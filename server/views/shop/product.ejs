<%- include('../partials/header', { title: product.name, user }) %>
<div class="max-w-2xl mx-auto py-4">
  <a href="/shop" class="text-primary hover:underline mb-6 inline-block cursor-pointer text-sm">← 返回列表</a>
  <div class="platform-card overflow-hidden border border-slate-200">
    <% if (product.cover_image) { %><img src="<%= product.cover_image %>" alt="<%= product.name %>" class="w-full max-h-64 object-cover rounded-t-xl" /><% } %>
    <div class="p-6 lg:p-8">
      <h1 class="text-xl font-bold text-platform-primary mb-2 title-deco"><%= product.name %></h1>
      <div id="productDesc" class="text-platform-muted mb-6 prose prose-slate max-w-none text-sm"><%= product.description || '暂无说明' %></div>
      <div class="flex items-center gap-4 mb-6">
        <span class="text-primary font-semibold text-xl">¥ <%= Number(product.price).toFixed(2) %></span>
        <span class="text-platform-soft text-sm">库存 <%= product.stock === -1 ? '无限' : product.stock %></span>
      </div>
      <% if (product.stock !== 0) { %>
      <form id="orderForm" class="space-y-4">
        <input type="hidden" name="product_id" value="<%= product.id %>" />
        <div>
          <label class="block text-platform-muted text-sm font-medium mb-1">数量</label>
          <input type="number" name="quantity" min="1" max="<%= product.stock === -1 ? 100 : Math.min(100, product.stock) %>" value="1" class="platform-input px-3 py-2 w-24" />
        </div>
        <div>
          <label class="block text-platform-muted text-sm font-medium mb-1">联系/备注（选填）</label>
          <input type="text" name="contact" placeholder="邮箱或备注" class="platform-input px-3 py-2 w-full" maxlength="200" />
        </div>
        <button type="submit" class="btn-primary px-6 py-3" id="payBtn">去支付（Linux.do 积分）</button>
      </form>
      <p id="payError" class="text-red-600 text-sm mt-2 hidden"></p>
      <% } else { %>
      <p class="text-platform-soft text-sm">暂无库存</p>
      <% } %>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script>
(function(){
  var el = document.getElementById('productDesc');
  if (!el) return;
  var raw = (el.textContent || el.innerText || '').trim();
  if (!raw) { el.innerHTML = '<p class="text-platform-soft">暂无说明</p>'; return; }
  var html = typeof marked !== 'undefined' ? marked.parse(raw, { gfm: true }) : raw;
  el.innerHTML = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
})();
</script>
<% if (product.stock !== 0) { %>
<script>
  document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var btn = document.getElementById('payBtn');
    var err = document.getElementById('payError');
    err.classList.add('hidden');
    btn.disabled = true;
    btn.textContent = '跳转中…';
    try {
      var form = e.target;
      var fd = new FormData(form);
      var res = await fetch('/shop/order/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
        body: new URLSearchParams(fd).toString()
      });
      var data = await res.json();
      if (data.ok && data.redirectUrl) {
        location.href = data.redirectUrl;
        return;
      }
      err.textContent = data.message || '发起支付失败';
      err.classList.remove('hidden');
    } catch (x) {
      err.textContent = '网络错误';
      err.classList.remove('hidden');
    }
    btn.disabled = false;
    btn.textContent = '去支付（Linux.do 积分）';
  });
</script>
<% } %>
<%- include('../partials/footer') %>
