<%- include('../partials/header', { title: product.name, user }) %>
<div class="max-w-2xl mx-auto py-4">
  <a href="/shop" class="text-primary hover:underline mb-6 inline-block cursor-pointer text-sm">â† è¿”å›åˆ—è¡¨</a>
  <div class="platform-card overflow-hidden">
    <% if (product.cover_image) { %><img src="<%= product.cover_image %>" alt="<%= product.name %>" class="w-full max-h-64 object-cover rounded-t-2xl" /><% } %>
    <div class="p-6 lg:p-8">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-xl font-bold text-platform-primary title-deco"><%= product.name %></h1>
        <% if (product.is_hot === 1) { %>
        <span class="inline-flex items-center rounded-full bg-rose-500/10 text-rose-600 px-2 py-0.5 text-xs font-semibold">
          ğŸ”¥ çƒ­é—¨
        </span>
        <% } %>
      </div>
      <div id="productDesc" class="text-platform-muted mb-6 prose prose-slate max-w-none text-sm"><%= product.description || 'æš‚æ— è¯´æ˜' %></div>
      <div class="flex items-center gap-4 mb-6">
        <div class="flex items-baseline gap-2">
          <span class="text-primary font-semibold text-xl"><%= Number(product.price).toFixed(2) %> ç§¯åˆ†</span>
          <% if (product.original_price && product.original_price > product.price) { %>
          <span class="text-platform-soft text-sm line-through decoration-platform-soft/50">
            <%= Number(product.original_price).toFixed(2) %>
          </span>
          <% } %>
        </div>
        <span class="text-platform-soft text-sm">åº“å­˜ <%= product.stock === -1 ? 'æ— é™' : product.stock %></span>
      </div>
      <% if (product.stock !== 0) { %>
      <form id="orderForm" class="space-y-4">
        <input type="hidden" name="product_id" value="<%= product.id %>" />
        <div>
          <label class="block text-platform-muted text-sm font-medium mb-1">æ•°é‡</label>
          <input type="number" name="quantity" min="1" max="<%= product.stock === -1 ? 100 : Math.min(100, product.stock) %>" value="1" class="platform-input px-3 py-2 w-24" />
        </div>
        <% if (user && user.points > 0) { %>
        <div class="flex items-center gap-2 py-2">
          <input type="checkbox" name="use_points" id="usePoints" class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary" />
          <label for="usePoints" class="text-sm text-platform-muted cursor-pointer">ä½¿ç”¨ç§¯åˆ†æŠµæ‰£ (å¯ç”¨ <%= user.points %> ç§¯åˆ†)</label>
        </div>
        <% } %>
        <% if (user) { %>
         <button type="submit" class="btn-primary px-6 py-3" id="payBtn">å»æ”¯ä»˜</button>
         <% } else { %>
         <a href="/shop/login?next=/shop/product/<%= product.slug || product.id %>" class="btn-primary px-6 py-3 inline-block text-center no-underline">å»ç™»å½•</a>
         <% } %>
      </form>
      <p id="payError" class="text-red-600 text-sm mt-2 hidden"></p>

      <% } else { %>
      <p class="text-platform-soft text-sm">æš‚æ— åº“å­˜</p>
      <% } %>
    </div>
  </div>

  <!-- è¯„ä»·éƒ¨åˆ† -->
  <div class="mt-8 space-y-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-bold text-platform-primary flex items-center gap-2">
        ç”¨æˆ·è¯„ä»·
        <span class="text-sm font-normal text-platform-soft">(<%= ratingCount %>)</span>
      </h2>
      <% if (ratingCount > 0) { %>
      <div class="flex items-center gap-1">
        <span class="text-amber-400 text-lg">â˜…</span>
        <span class="font-bold text-platform-primary"><%= Number(ratingAvg).toFixed(1) %></span>
      </div>
      <% } %>
    </div>

    <% if (reviews && reviews.length > 0) { %>
    <div class="space-y-4">
      <% reviews.forEach(review => { %>
      <div class="platform-card p-6 border border-slate-100">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            <img src="<%= review.avatar_url || '/images/default-avatar.png' %>" alt="<%= review.username %>" class="w-8 h-8 rounded-full border border-slate-200">
            <div>
              <div class="text-sm font-semibold text-platform-primary"><%= review.username %></div>
              <div class="text-xs text-platform-soft"><%= new Date(review.created_at).toLocaleDateString() %></div>
            </div>
          </div>
          <div class="flex text-amber-400 text-sm">
            <% for(let i=1; i<=5; i++) { %>
            <span><%= i <= review.rating ? 'â˜…' : 'â˜†' %></span>
            <% } %>
          </div>
        </div>
        <div class="text-platform-muted text-sm leading-relaxed"><%= review.content || 'è¯¥ç”¨æˆ·æœªå¡«å†™è¯„ä»·å†…å®¹' %></div>
      </div>
      <% }) %>
    </div>
    <% } else { %>
    <div class="platform-card p-12 text-center border border-slate-100 bg-slate-50/50">
      <div class="text-4xl mb-4">ğŸ’¬</div>
      <p class="text-platform-soft text-sm">æš‚æ— è¯„ä»·ï¼Œè´­ä¹°åå¿«æ¥åˆ†äº«æ‚¨çš„ä½¿ç”¨æ„Ÿå—å§ï¼</p>
    </div>
    <% } %>
  </div>

  <div id="imageLightbox" class="fixed inset-0 z-[100] hidden items-center justify-center p-4" aria-hidden="true">
    <div id="imageLightboxBackdrop" class="absolute inset-0 bg-black/80 cursor-pointer" tabindex="0"></div>
    <img id="imageLightboxImg" src="" alt="" class="relative z-10 max-w-full max-h-[90vh] w-auto h-auto object-contain rounded-lg shadow-2xl pointer-events-none" />
    <button type="button" id="imageLightboxClose" class="absolute top-4 right-4 z-20 w-10 h-10 rounded-full bg-white/90 hover:bg-white text-slate-700 flex items-center justify-center cursor-pointer text-xl leading-none" aria-label="å…³é—­">Ã—</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script>
(function(){
  var el = document.getElementById('productDesc');
  if (!el) return;
  var raw = (el.textContent || el.innerText || '').trim();
  if (!raw) { el.innerHTML = '<p class="text-platform-soft">æš‚æ— è¯´æ˜</p>'; return; }
  var html = typeof marked !== 'undefined' ? marked.parse(raw, { gfm: true }) : raw;
  el.innerHTML = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;

  var lightbox = document.getElementById('imageLightbox');
  var lightboxImg = document.getElementById('imageLightboxImg');
  var backdrop = document.getElementById('imageLightboxBackdrop');
  var closeBtn = document.getElementById('imageLightboxClose');
  if (!lightbox || !lightboxImg) return;

  function openLightbox(src, alt) {
    lightboxImg.src = src;
    lightboxImg.alt = alt || '';
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lightbox.classList.add('hidden');
    lightbox.classList.remove('flex');
    document.body.style.overflow = '';
  }

  var imgs = el.querySelectorAll('img');
  imgs.forEach(function(img) {
    img.classList.add('cursor-pointer', 'hover:opacity-90');
    img.title = 'ç‚¹å‡»æ”¾å¤§';
    img.addEventListener('click', function(e) {
      e.preventDefault();
      openLightbox(img.src, img.alt);
    });
  });

  backdrop.addEventListener('click', closeLightbox);
  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) closeLightbox();
  });
})();
</script>
<% if (product.stock !== 0) { %>
<div id="payConfirmModal" class="fixed inset-0 z-[200] hidden" aria-hidden="true">
  <div class="fixed inset-0 bg-black/50" id="payConfirmOverlay"></div>
  <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm mx-auto p-6">
    <div class="platform-card p-6 shadow-xl">
      <h3 class="text-lg font-semibold text-platform-primary mb-2">å³å°†å»æ”¯ä»˜</h3>
      <p class="text-platform-muted text-sm mb-6">å°†è·³è½¬åˆ° Linux.do ç§¯åˆ†æ”¯ä»˜é¡µé¢ï¼Œè¯·ç¡®è®¤åç»§ç»­ã€‚</p>
      <div class="flex gap-3 justify-end">
        <button type="button" id="payConfirmCancel" class="btn-secondary cursor-pointer">å–æ¶ˆ</button>
        <button type="button" id="payConfirmOk" class="btn-primary cursor-pointer">ç¡®å®š</button>
      </div>
    </div>
  </div>
</div>
<script>
(function() {
  var form = document.getElementById('orderForm');
  var modal = document.getElementById('payConfirmModal');
  var overlay = document.getElementById('payConfirmOverlay');
  var btnCancel = document.getElementById('payConfirmCancel');
  var btnOk = document.getElementById('payConfirmOk');
  var btn = document.getElementById('payBtn');
  var err = document.getElementById('payError');

  function showModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function hideModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  function doPay() {
    hideModal();
    err.classList.add('hidden');
    btn.disabled = true;
    btn.textContent = 'è·³è½¬ä¸­â€¦';
    var fd = new FormData(form);
    fetch('/shop/order/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
      body: new URLSearchParams(fd).toString()
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.ok && data.redirectUrl) {
        location.href = data.redirectUrl;
        return;
      }
      err.textContent = data.message || 'å‘èµ·æ”¯ä»˜å¤±è´¥';
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'å»æ”¯ä»˜ï¼ˆLinux.do ç§¯åˆ†ï¼‰';
    })
    .catch(function() {
      err.textContent = 'ç½‘ç»œé”™è¯¯';
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'å»æ”¯ä»˜ï¼ˆLinux.do ç§¯åˆ†ï¼‰';
    });
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    showModal();
  });
  btnCancel.addEventListener('click', hideModal);
  overlay.addEventListener('click', hideModal);
  btnOk.addEventListener('click', doPay);
})();
</script>
<% } %>
<%- include('../partials/footer') %>
