<%- include('../partials/header', { title: product.name, user }) %>
<div class="max-w-2xl mx-auto py-4">
  <a href="/shop" class="text-primary hover:underline mb-6 inline-block cursor-pointer text-sm">← 返回列表</a>
  <div class="platform-card overflow-hidden">
    <% if (product.cover_image) { %><img src="<%= product.cover_image %>" alt="<%= product.name %>" class="w-full max-h-64 object-cover rounded-t-2xl" /><% } %>
    <div class="p-6 lg:p-8">
      <h1 class="text-xl font-bold text-platform-primary mb-2 title-deco"><%= product.name %></h1>
      <div id="productDesc" class="text-platform-muted mb-6 prose prose-slate max-w-none text-sm"><%= product.description || '暂无说明' %></div>
      <div class="flex items-center gap-4 mb-6">
        <span class="text-primary font-semibold text-xl">¥ <%= Number(product.price).toFixed(2) %></span>
        <span class="text-platform-soft text-sm">库存 <%= product.stock === -1 ? '无限' : product.stock %></span>
      </div>
      <% if (product.stock !== 0) { %>
      <form id="orderForm" class="space-y-4">
        <input type="hidden" name="product_id" value="<%= product.id %>" />
        <div>
          <label class="block text-platform-muted text-sm font-medium mb-1">数量</label>
          <input type="number" name="quantity" min="1" max="<%= product.stock === -1 ? 100 : Math.min(100, product.stock) %>" value="1" class="platform-input px-3 py-2 w-24" />
        </div>
        <% if (user) { %>
        <button type="submit" class="btn-primary px-6 py-3" id="payBtn">去支付（Linux.do 积分）</button>
        <% } else { %>
        <a href="/shop/login?next=/shop/product/<%= product.id %>" class="btn-primary px-6 py-3 inline-block text-center no-underline">去支付（Linux.do 积分）</a>
        <% } %>
      </form>
      <p id="payError" class="text-red-600 text-sm mt-2 hidden"></p>

      <div id="payConfirmModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="fixed inset-0 bg-black/50" id="payConfirmOverlay"></div>
        <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm mx-auto p-6">
          <div class="platform-card p-6 shadow-xl">
            <h3 class="text-lg font-semibold text-platform-primary mb-2">即将去支付</h3>
            <p class="text-platform-muted text-sm mb-6">将跳转到 Linux.do 积分支付页面，请确认后继续。</p>
            <div class="flex gap-3 justify-end">
              <button type="button" id="payConfirmCancel" class="btn-secondary cursor-pointer">取消</button>
              <button type="button" id="payConfirmOk" class="btn-primary cursor-pointer">确定</button>
            </div>
          </div>
        </div>
      </div>
      <% } else { %>
      <p class="text-platform-soft text-sm">暂无库存</p>
      <% } %>
    </div>
  </div>
  <div id="imageLightbox" class="fixed inset-0 z-[100] hidden items-center justify-center p-4" aria-hidden="true">
    <div id="imageLightboxBackdrop" class="absolute inset-0 bg-black/80 cursor-pointer" tabindex="0"></div>
    <img id="imageLightboxImg" src="" alt="" class="relative z-10 max-w-full max-h-[90vh] w-auto h-auto object-contain rounded-lg shadow-2xl pointer-events-none" />
    <button type="button" id="imageLightboxClose" class="absolute top-4 right-4 z-20 w-10 h-10 rounded-full bg-white/90 hover:bg-white text-slate-700 flex items-center justify-center cursor-pointer text-xl leading-none" aria-label="关闭">×</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script>
(function(){
  var el = document.getElementById('productDesc');
  if (!el) return;
  var raw = (el.textContent || el.innerText || '').trim();
  if (!raw) { el.innerHTML = '<p class="text-platform-soft">暂无说明</p>'; return; }
  var html = typeof marked !== 'undefined' ? marked.parse(raw, { gfm: true }) : raw;
  el.innerHTML = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;

  var lightbox = document.getElementById('imageLightbox');
  var lightboxImg = document.getElementById('imageLightboxImg');
  var backdrop = document.getElementById('imageLightboxBackdrop');
  var closeBtn = document.getElementById('imageLightboxClose');
  if (!lightbox || !lightboxImg) return;

  function openLightbox(src, alt) {
    lightboxImg.src = src;
    lightboxImg.alt = alt || '';
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lightbox.classList.add('hidden');
    lightbox.classList.remove('flex');
    document.body.style.overflow = '';
  }

  var imgs = el.querySelectorAll('img');
  imgs.forEach(function(img) {
    img.classList.add('cursor-pointer', 'hover:opacity-90');
    img.title = '点击放大';
    img.addEventListener('click', function(e) {
      e.preventDefault();
      openLightbox(img.src, img.alt);
    });
  });

  backdrop.addEventListener('click', closeLightbox);
  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) closeLightbox();
  });
})();
</script>
<% if (product.stock !== 0) { %>
<script>
(function() {
  var form = document.getElementById('orderForm');
  var modal = document.getElementById('payConfirmModal');
  var overlay = document.getElementById('payConfirmOverlay');
  var btnCancel = document.getElementById('payConfirmCancel');
  var btnOk = document.getElementById('payConfirmOk');
  var btn = document.getElementById('payBtn');
  var err = document.getElementById('payError');

  function showModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function hideModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  function doPay() {
    hideModal();
    err.classList.add('hidden');
    btn.disabled = true;
    btn.textContent = '跳转中…';
    var fd = new FormData(form);
    fetch('/shop/order/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
      body: new URLSearchParams(fd).toString()
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.ok && data.redirectUrl) {
        location.href = data.redirectUrl;
        return;
      }
      err.textContent = data.message || '发起支付失败';
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = '去支付（Linux.do 积分）';
    })
    .catch(function() {
      err.textContent = '网络错误';
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = '去支付（Linux.do 积分）';
    });
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    showModal();
  });
  btnCancel.addEventListener('click', hideModal);
  overlay.addEventListener('click', hideModal);
  btnOk.addEventListener('click', doPay);
})();
</script>
<% } %>
<%- include('../partials/footer') %>
